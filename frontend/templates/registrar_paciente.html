<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Paciente</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #eef3f7;
            font-family: "Segoe UI", sans-serif;
        }

        header {
            background-color: #0078d7;
            color: white;
            padding: 1rem;
            text-align: center;
            font-weight: bold;
            font-size: 1.4rem;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .card {
            max-width: 900px;
            margin: auto;
            margin-top: 30px;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            background: white;
        }

        .is-invalid {
            border: 2px solid red !important;
        }
    </style>
</head>

<body>

<header>üè• SISTEMA HISTORIA CL√çNICA CON FHIR</header>

<div class="container">

    <div class="card">

        <h3 class="text-center mb-4">Registrar Paciente</h3>

        <form id="registroPacienteForm">

            <div class="row">

                <!-- Nombres y apellidos -->
                <div class="col-md-6 mb-3">
                    <label>Primer Nombre</label>
                    <input type="text" id="primerNombre" class="form-control">
                </div>

                <div class="col-md-6 mb-3">
                    <label>Segundo Nombre</label>
                    <input type="text" id="segundoNombre" class="form-control">
                </div>

                <div class="col-md-6 mb-3">
                    <label>Primer Apellido</label>
                    <input type="text" id="primerApellido" class="form-control">
                </div>

                <div class="col-md-6 mb-3">
                    <label>Segundo Apellido</label>
                    <input type="text" id="segundoApellido" class="form-control">
                </div>

                <!-- Tipo de documento -->
                <div class="col-md-6 mb-3">
                    <label>Tipo de Documento</label>
                    <select id="tipoDocumento" class="form-select">
                        <option value="">Seleccione</option>
                        <option>C√©dula</option>
                        <option>Tarjeta de identidad</option>
                        <option>Pasaporte</option>
                        <option>C√©dula de extranjer√≠a</option>
                    </select>
                </div>

                <!-- N√∫mero documento -->
                <div class="col-md-6 mb-3">
                    <label>N√∫mero de Documento</label>
                    <input type="number" id="numDocumento" class="form-control">
                </div>

                <!-- Sexo -->
                <div class="col-md-6 mb-3">
                    <label>Sexo</label>
                    <select id="sexo" class="form-select">
                        <option value="">Seleccione</option>
                        <option>Masculino</option>
                        <option>Femenino</option>
                        <option>Otro</option>
                    </select>
                </div>

                <!-- Grupo sangu√≠neo -->
                <div class="col-md-6 mb-3">
                    <label>Grupo Sangu√≠neo</label>
                    <select id="grupo" class="form-select">
                        <option value="">Seleccione</option>
                        <option>O+</option><option>O-</option>
                        <option>A+</option><option>A-</option>
                        <option>B+</option><option>B-</option>
                        <option>AB+</option><option>AB-</option>
                    </select>
                </div>

                <!-- Departamento -->
                <div class="col-md-6 mb-3">
                    <label>Departamento</label>
                    <select id="departamento" class="form-select"></select>
                </div>

                <div class="col-md-6 mb-3">
                    <label>Municipio</label>
                    <select id="municipio" class="form-select"></select>
                </div>

                <div class="col-md-6 mb-3">
                    <label>Ocupaci√≥n</label>
                    <select id="ocupacion" class="form-select">
                        <option value="">Seleccione</option>
                        <option>T√©cnico</option>
                        <option>Tecn√≥logo</option>
                        <option>Profesional</option>
                        <option>Practicante</option>
                        <option>Independiente</option>
                        <option>Desempleado</option>
                    </select>
                </div>

                <!-- Pa√≠s -->
                <div class="col-md-6 mb-3">
                    <label>Pa√≠s</label>
                    <select id="pais" class="form-select">
                        <option value="">Seleccione</option>
                        <option>Colombia</option>
                        <option>Venezuela</option>
                        <option>Ecuador</option>
                        <option>Per√∫</option>
                        <option>Otro</option>
                    </select>
                </div>

                <!-- Contacto de emergencia -->
                <div class="col-md-6 mb-3">
                    <label>Contacto de emergencia</label>
                    <input type="number" id="contactoEmergencia" class="form-control">
                </div>

                <!-- Tel√©fono -->
                <div class="col-md-6 mb-3">
                    <label>Tel√©fono</label>
                    <input type="number" id="telefono" class="form-control">
                </div>

                <!-- Correo -->
                <div class="col-md-6 mb-3">
                    <label>Correo</label>
                    <input type="email" id="correo" class="form-control">
                </div>

            </div>

            <button type="button" class="btn btn-primary w-100 mt-4" onclick="abrirConfirmacion()">
                Terminar registro del paciente
            </button>

        </form>

    </div>
</div>

<!-- CONFIRMAR REGISTRO -->
<div class="modal fade" id="modalConfirmar" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-primary">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Confirmar Registro</h5>
      </div>
      <div class="modal-body text-center">
        ¬øDesea guardar los datos del paciente?
      </div>
      <div class="modal-footer justify-content-center">
        <button class="btn btn-secondary" data-bs-dismiss="modal">No</button>
        <button class="btn btn-primary" onclick="registrar()">S√≠</button>
      </div>
    </div>
  </div>
</div>

<!-- REGISTRO EXITOSO -->
<div class="modal fade" id="modalExito" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-success">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Registro Exitoso</h5>
      </div>
      <div class="modal-body text-center">
        <h4>üéâ Paciente registrado correctamente</h4>
        <p>ID asignado:</p>
        <h2 id="idGenerado" class="fw-bold text-success"></h2>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

// -----------------------------
// Cargar departamentos + municipios
// -----------------------------

let departamentosData = {};

async function cargarDepartamentos() {
    const res = await fetch("/departamentos.json");
    departamentosData = await res.json();

    const depSelect = document.getElementById("departamento");
    depSelect.innerHTML = "<option value=''>Seleccione</option>";

    Object.keys(departamentosData).forEach(dep => {
        let op = document.createElement("option");
        op.value = dep;
        op.textContent = dep;
        depSelect.appendChild(op);
    });
}

document.getElementById("departamento").addEventListener("change", () => {
    const municipioSelect = document.getElementById("municipio");
    municipioSelect.innerHTML = "<option value=''>Seleccione</option>";

    let selectedDep = document.getElementById("departamento").value;
    if (!selectedDep) return;

    departamentosData[selectedDep].forEach(m => {
        let op = document.createElement("option");
        op.value = m;
        op.textContent = m;
        municipioSelect.appendChild(op);
    });
});

cargarDepartamentos();

// -----------------------------
// MODAL CONFIRMAR
// -----------------------------

function abrirConfirmacion() {
    new bootstrap.Modal(document.getElementById("modalConfirmar")).show();
}

// -----------------------------
// REGISTRAR PACIENTE
// -----------------------------

async function registrar() {

    // Generar ID aleatorio
    const idGenerado = Math.floor(Math.random() * (99999 - 10000 + 1)) + 10000;

    const datos = {
        id: idGenerado,
        primerNombre: primerNombre.value.trim(),
        segundoNombre: segundoNombre.value.trim(),
        primerApellido: primerApellido.value.trim(),
        segundoApellido: segundoApellido.value.trim(),
        tipoDocumento: tipoDocumento.value,
        numDocumento: numDocumento.value.trim(),
        sexo: sexo.value,
        grupo: grupo.value,
        departamento: departamento.value,
        municipio: municipio.value,
        ocupacion: ocupacion.value,
        pais: pais.value,
        contactoEmergencia: contactoEmergencia.value.trim(),
        telefono: telefono.value.trim(),
        correo: correo.value.trim()
    };

    // Validaci√≥n r√°pida
    let valid = true;
    Object.keys(datos).forEach(k => {
        const campo = document.getElementById(k);
        if (campo && campo.value.trim() === "") {
            campo.classList.add("is-invalid");
            valid = false;
        }
    });

    if (!valid) {
        document.getElementById("modalConfirmar").classList.remove("show");
        return;
    }

    // Enviar al backend
    await fetch("/guardar_paciente", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(datos)
    });

    document.getElementById("idGenerado").textContent = idGenerado;

    let modalExito = new bootstrap.Modal(document.getElementById("modalExito"));
    modalExito.show();

    setTimeout(() => {
        window.location.href = "{{ url_for('vista_medico') }}";
    }, 3000);
}

</script>

</body>
</html>
