<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Historia Cl√≠nica - HCE</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: "Segoe UI", sans-serif;
            padding: 2rem 0;
        }
        .form-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .section-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            margin: 2rem 0 1.5rem 0;
            font-weight: 600;
        }
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        .btn-submit {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 1rem 3rem;
            border-radius: 10px;
            font-weight: 600;
        }
        .loading {
            text-align: center;
            padding: 3rem;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="form-container">

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 text-muted">Cargando datos del paciente...</p>
            </div>

            <!-- Contenido -->
            <div id="content" class="d-none">

                <!-- Header -->
                <div class="text-center mb-4">
                    <h2 class="fw-bold text-primary">‚úèÔ∏è Editar Historia Cl√≠nica</h2>
                    <h5 class="text-muted" id="nombrePaciente"></h5>
                    <p class="text-muted">Documento: <span id="documentoPaciente"></span></p>
                </div>

                <form id="formEditar">

                    <!-- ATENCI√ìN M√âDICA -->
                    <div class="section-header">üè• ATENCI√ìN M√âDICA</div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo de Atenci√≥n</label>
                            <select id="tipo_atencion" class="form-select">
                                <option value="">Seleccione...</option>
                                <option value="Urgencias">Urgencias</option>
                                <option value="Consulta Externa">Consulta Externa</option>
                                <option value="Hospitalizacion">Hospitalizaci√≥n</option>
                                <option value="Cirugia">Cirug√≠a</option>
                                <option value="Procedimiento">Procedimiento</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Motivo de Consulta</label>
                            <input type="text" id="motivo_consulta" class="form-control">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Enfermedad Actual</label>
                            <textarea id="enfermedad_actual" class="form-control" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- ANTECEDENTES -->
                    <div class="section-header">üìù ANTECEDENTES</div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Antecedentes Personales</label>
                            <textarea id="antecedentes_personales" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Antecedentes Familiares</label>
                            <textarea id="antecedentes_familiares" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Alergias Conocidas</label>
                            <textarea id="alergias_conocidas" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">H√°bitos</label>
                            <textarea id="habitos" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Medicamentos Actuales</label>
                            <textarea id="medicamentos_actuales" class="form-control" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- SIGNOS VITALES -->
                    <div class="section-header">üíì SIGNOS VITALES</div>
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Tensi√≥n Arterial</label>
                            <input type="text" id="tension_arterial" class="form-control" placeholder="120/80">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Frecuencia Card√≠aca</label>
                            <input type="number" id="frecuencia_cardiaca" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Frecuencia Respiratoria</label>
                            <input type="number" id="frecuencia_respiratoria" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Temperatura</label>
                            <input type="number" step="0.1" id="temperatura" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Saturaci√≥n O‚ÇÇ</label>
                            <input type="number" id="saturacion_oxigeno" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Peso (kg)</label>
                            <input type="number" step="0.1" id="peso" class="form-control">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">Talla (cm)</label>
                            <input type="number" step="0.1" id="talla" class="form-control">
                        </div>
                    </div>

                    <!-- EXAMEN F√çSICO -->
                    <div class="section-header">üî¨ EXAMEN F√çSICO</div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Examen F√≠sico General</label>
                            <textarea id="examen_fisico_general" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Examen F√≠sico por Sistemas</label>
                            <textarea id="examen_fisico_sistemas" class="form-control" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- DIAGN√ìSTICO -->
                    <div class="section-header">üìã DIAGN√ìSTICO</div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Impresi√≥n Diagn√≥stica</label>
                            <textarea id="impresion_diagnostica" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">C√≥digos CIE-10</label>
                            <input type="text" id="codigos_cie10" class="form-control">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Diagn√≥stico Definitivo</label>
                            <textarea id="diagnostico_definitivo" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Conducta / Plan de Manejo</label>
                            <textarea id="conducta_plan" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Recomendaciones</label>
                            <textarea id="recomendaciones" class="form-control" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- TRATAMIENTO -->
                    <div class="section-header">üíä TRATAMIENTO</div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tratamiento Instaurado</label>
                            <textarea id="tratamiento_instaurado" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Formulaci√≥n M√©dica</label>
                            <textarea id="formulacion_medica" class="form-control" rows="2"></textarea>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Educaci√≥n al Paciente</label>
                            <textarea id="educacion_paciente" class="form-control" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- PROCEDIMIENTOS -->
                    <div class="section-header">üî¨ PROCEDIMIENTOS</div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">M√©dicos Interconsultados</label>
                            <input type="text" id="medicos_interconsultados" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Procedimientos Realizados</label>
                            <input type="text" id="procedimientos_realizados" class="form-control">
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Resultados de Ex√°menes</label>
                            <textarea id="resultados_examenes" class="form-control" rows="3"></textarea>
                        </div>
                    </div>

                    <!-- EVOLUCI√ìN -->
                    <div class="section-header">üìä EVOLUCI√ìN Y EGRESO</div>
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label class="form-label">Evoluci√≥n M√©dica</label>
                            <textarea id="evolucion_medica" class="form-control" rows="3"></textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Referencia/Contrarreferencia</label>
                            <input type="text" id="referencia_contrarreferencia" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Estado de Egreso</label>
                            <select id="estado_egreso" class="form-select">
                                <option value="">Seleccione...</option>
                                <option value="Mejorado">Mejorado</option>
                                <option value="Igual">Igual</option>
                                <option value="Empeorado">Empeorado</option>
                                <option value="Fallecido">Fallecido</option>
                                <option value="Remitido">Remitido</option>
                            </select>
                        </div>
                    </div>

                    <!-- PROFESIONAL -->
                    <div class="section-header">üë®‚Äç‚öïÔ∏è PROFESIONAL</div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre del Profesional</label>
                            <input type="text" id="nombre_profesional" class="form-control">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tipo de Profesional</label>
                            <input type="text" id="tipo_profesional" class="form-control">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Registro M√©dico</label>
                            <input type="text" id="registro_medico" class="form-control">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Cargo/Servicio</label>
                            <input type="text" id="cargo_servicio" class="form-control">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Responsable de Registro</label>
                            <input type="text" id="responsable_registro" class="form-control">
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-secondary me-3" onclick="window.history.back()">
                            ‚Üê Cancelar
                        </button>
                        <button type="submit" class="btn btn-submit">
                            üíæ Guardar Cambios
                        </button>
                    </div>

                </form>

            </div>

        </div>
    </div>

    <!-- Modal √âxito -->
    <div class="modal fade" id="modalExito" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">‚úÖ Actualizaci√≥n Exitosa</h5>
                </div>
                <div class="modal-body text-center">
                    <h4>Historia cl√≠nica actualizada correctamente</h4>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary" onclick="volverAVista()">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="../static/js/config.js"></script>
    <script>
        // ==================== INICIALIZACI√ìN ====================
        let documentoActual = null;

        window.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                cargarDatos();
            }
        });

        // ==================== VERIFICAR AUTENTICACI√ìN ====================
        function checkAuth() {
            const user = AUTH_UTILS.getUser();
            if (!user) {
                window.location.href = 'login.html';
                return false;
            }
            
            if (!['medico', 'admin'].includes(user.rol)) {
                UI_UTILS.showAlert('Solo m√©dicos pueden editar historias cl√≠nicas', 'danger');
                window.location.href = 'login.html';
                return false;
            }

            return true;
        }

        // ==================== OBTENER DOCUMENTO ====================
        function getDocumentoFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('documento');
        }

        // ==================== CARGAR DATOS ====================
        async function cargarDatos() {
            documentoActual = getDocumentoFromURL();

            if (!documentoActual) {
                UI_UTILS.showAlert('No se especific√≥ el documento del paciente', 'danger');
                window.history.back();
                return;
            }

            try {
                const paciente = await API_UTILS.get(ENDPOINTS.PACIENTES_DETAIL(documentoActual));
                if(paciente) {
                    llenarFormulario(paciente);
                } else {
                    UI_UTILS.showAlert('Error al cargar los datos del paciente', 'danger');
                    window.history.back();
                }
            } catch (error) {
                UI_UTILS.showAlert('Error de conexi√≥n', 'danger');
            }
        }

        // ==================== LLENAR FORMULARIO ====================
        function llenarFormulario(p) {
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('content').classList.remove('d-none');

            // Header
            const nombreCompleto = `${p.primer_nombre || ''} ${p.segundo_nombre || ''} ${p.primer_apellido || ''} ${p.segundo_apellido || ''}`.trim();
            document.getElementById('nombrePaciente').textContent = nombreCompleto;
            document.getElementById('documentoPaciente').textContent = p.numero_documento;

            // Llenar campos
            const campos = [
                'tipo_atencion', 'motivo_consulta', 'enfermedad_actual',
                'antecedentes_personales', 'antecedentes_familiares', 'alergias_conocidas',
                'habitos', 'medicamentos_actuales', 'tension_arterial', 'frecuencia_cardiaca',
                'frecuencia_respiratoria', 'temperatura', 'saturacion_oxigeno', 'peso', 'talla',
                'examen_fisico_general', 'examen_fisico_sistemas', 'impresion_diagnostica',
                'codigos_cie10', 'diagnostico_definitivo', 'conducta_plan', 'recomendaciones',
                'tratamiento_instaurado', 'formulacion_medica', 'educacion_paciente',
                'medicos_interconsultados', 'procedimientos_realizados', 'resultados_examenes',
                'evolucion_medica', 'referencia_contrarreferencia', 'estado_egreso',
                'nombre_profesional', 'tipo_profesional', 'registro_medico', 'cargo_servicio',
                'responsable_registro'
            ];

            campos.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento && p[campo] !== null && p[campo] !== undefined) {
                    elemento.value = p[campo];
                }
            });
        }

        // ==================== GUARDAR CAMBIOS ====================
        document.getElementById('formEditar').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Recopilar solo los campos modificados
            const datos = {};
            
            const campos = [
                'tipo_atencion', 'motivo_consulta', 'enfermedad_actual',
                'antecedentes_personales', 'antecedentes_familiares', 'alergias_conocidas',
                'habitos', 'medicamentos_actuales', 'tension_arterial',
                'examen_fisico_general', 'examen_fisico_sistemas', 'impresion_diagnostica',
                'codigos_cie10', 'diagnostico_definitivo', 'conducta_plan', 'recomendaciones',
                'tratamiento_instaurado', 'formulacion_medica', 'educacion_paciente',
                'medicos_interconsultados', 'procedimientos_realizados', 'resultados_examenes',
                'evolucion_medica', 'referencia_contrarreferencia', 'estado_egreso',
                'nombre_profesional', 'tipo_profesional', 'registro_medico', 'cargo_servicio',
                'responsable_registro'
            ];

            campos.forEach(campo => {
                const valor = document.getElementById(campo).value;
                if (valor.trim() !== '') {
                    datos[campo] = valor;
                }
            });

            // Campos num√©ricos
            ['frecuencia_cardiaca', 'frecuencia_respiratoria', 'saturacion_oxigeno'].forEach(campo => {
                const valor = document.getElementById(campo).value;
                if (valor) datos[campo] = parseInt(valor);
            });

            ['temperatura', 'peso', 'talla'].forEach(campo => {
                const valor = document.getElementById(campo).value;
                if (valor) datos[campo] = parseFloat(valor);
            });

            try {
                const response = await API_UTILS.put(ENDPOINTS.PACIENTES_UPDATE(documentoActual), datos);
                if(response) {
                    const modal = new bootstrap.Modal(document.getElementById('modalExito'));
                    modal.show();
                }
            } catch (error) {
                UI_UTILS.showAlert(`Error al actualizar: ${error.message}`, 'danger');
            }
        });

        // ==================== VOLVER ====================
        function volverAVista() {
            window.location.href = `ver_historia_clinica.html?documento=${documentoActual}`;
        }
    </script>
</body>
</html>