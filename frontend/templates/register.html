<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de usuario</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background-color: #eef3f7;
        }

        .card {
            max-width: 650px;
            margin: auto;
            margin-top: 40px;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .is-invalid {
            border: 3px solid #dc3545 !important;
            background-color: #ffecec !important;
        }

        .seccion-oculta {
            display: none;
        }
    </style>

</head>
<body>

<div class="card">
    <h3 class="text-center mb-3">Crear nueva cuenta</h3>

    <form id="registroForm">

        <div class="mb-3">
            <label class="form-label">Usuario</label>
            <input type="text" id="usuario" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Contrase√±a</label>
            <input type="password" id="contrase√±a" class="form-control">
        </div>

        <div class="mb-3">
            <label class="form-label">Rol</label>
            <select class="form-select" id="rol">
                <option value="">Seleccione rol</option>
                <option value="medico">M√©dico</option>
                <option value="admisionista">Admisionista</option>
            </select>
        </div>

        <!-- M√âDICO -->
        <div id="formMedico" class="seccion-oculta">
            <h5 class="mt-3 mb-3">Datos del Profesional</h5>

            <div class="row">

                <div class="col-md-6 mb-3">
                    <label>Nombres</label>
                    <input type="text" id="medNombre" class="form-control">
                </div>

                <div class="col-md-6 mb-3">
                    <label>Apellidos</label>
                    <input type="text" id="medApellidos" class="form-control">
                </div>

                <div class="col-md-6 mb-3">
                    <label>Tipo de profesional</label>
                    <select id="medTipoProfesional" class="form-select">
                        <option value="">Seleccione</option>
                        <option>General</option>
                        <option>Internista</option>
                        <option>Nutricionista</option>
                        <option>Pediatra</option>
                        <option>Cardi√≥logo</option>
                        <option>Enfermero(a)</option>
                    </select>
                </div>

                <div class="col-md-6 mb-3">
                    <label>Tel√©fono</label>
                    <input type="text" id="medTelefono" class="form-control">
                </div>

                <div class="col-md-6 mb-3">
                    <label>Correo</label>
                    <input type="email" id="medCorreo" class="form-control">
                </div>

                <div class="col-md-6 mb-3">
                    <label>Tipo de identificaci√≥n</label>
                    <select id="medTipoID" class="form-select">
                        <option>C√©dula</option>
                        <option>Tarjeta de identidad</option>
                        <option>Pasaporte</option>
                    </select>
                </div>

                <div class="col-md-6 mb-3">
                    <label>N√∫mero de identificaci√≥n</label>
                    <input type="text" id="medNumID" class="form-control">
                </div>

                <div class="col-md-6 mb-4">
                    <label>ID Tarjeta profesional</label>
                    <input type="text" id="medTarjetaProf" class="form-control">
                </div>
            </div>
        </div>

        <!-- ADMISIONISTA -->
        <div id="formAdmisionista" class="seccion-oculta">

            <h5 class="mt-4 mb-3">Datos del Admisionista</h5>

            <div class="row">

                <div class="col-md-6 mb-3">
                    <label>Nombres</label>
                    <input type="text" id="admNombre" class="form-control">
                </div>

                <div class="col-md-6 mb-3">
                    <label>Apellidos</label>
                    <input type="text" id="admApellidos" class="form-control">
                </div>

                <div class="col-md-6 mb-3">
                    <label>Tipo de identificaci√≥n</label>
                    <select id="admTipoID" class="form-select">
                        <option>C√©dula</option>
                        <option>Tarjeta de identidad</option>
                        <option>Pasaporte</option>
                    </select>
                </div>

                <div class="col-md-6 mb-3">
                    <label>N√∫mero de identificaci√≥n</label>
                    <input type="text" id="admNumID" class="form-control">
                </div>

                <div class="col-md-6 mb-3">
                    <label>Tel√©fono</label>
                    <input type="text" id="admTelefono" class="form-control">
                </div>

                <div class="col-md-6 mb-3">
                    <label>Correo</label>
                    <input type="email" id="admCorreo" class="form-control">
                </div>

                <div class="col-md-6 mb-3">
                    <label>Cargo o puesto</label>
                    <select id="admCargo" class="form-select">
                        <option>Admisionista</option>
                        <option>Recepcionista</option>
                        <option>Auxiliar administrativo</option>
                        <option>Secretar√≠a</option>
                    </select>
                </div>

                <div class="col-md-6 mb-3">
                    <label>√Årea o dependencia</label>
                    <select id="admArea" class="form-select">
                        <option>Urgencias</option>
                        <option>Consulta externa</option>
                        <option>Laboratorio</option>
                        <option>Facturaci√≥n</option>
                    </select>
                </div>

                <div class="col-md-6 mb-4">
                    <label>Fecha de ingreso laboral</label>
                    <input type="date" id="admFechaIngreso" class="form-control">
                </div>

            </div>
        </div>

        <button type="submit" class="btn btn-primary w-100 mt-3">Registrar</button>

        <a href="{{ url_for('login') }}" class="btn btn-secondary w-100 mt-2">Volver al inicio</a>
    </form>
</div>

<!-- MODAL √âXITO -->
<div class="modal fade" id="modalExito" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-success">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">Registro exitoso</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        üéâ ¬°El usuario ha sido registrado correctamente!
      </div>
    </div>
  </div>
</div>

<!-- MODAL ERROR -->
<div class="modal fade" id="modalError" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Error en el registro</h5>
        <button type="button" class="btn-close"></button>
      </div>
      <div class="modal-body text-center" id="modalErrorMsg"></div>
    </div>
  </div>
</div>


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>

    const rolSelect = document.getElementById("rol");
    const medicoForm = document.getElementById("formMedico");
    const admForm = document.getElementById("formAdmisionista");

    rolSelect.addEventListener("change", () => {
        medicoForm.style.display = rolSelect.value === "medico" ? "block" : "none";
        admForm.style.display = rolSelect.value === "admisionista" ? "block" : "none";
    });

    function marcarError(c) { c.classList.add("is-invalid"); }
    function limpiarError(c) { c.classList.remove("is-invalid"); }

    document.addEventListener("input", (e) => {
        if (e.target.classList.contains("is-invalid")) limpiarError(e.target);
    });

    function mostrarError(msg) {
        document.getElementById("modalErrorMsg").innerHTML = msg;
        new bootstrap.Modal(document.getElementById("modalError")).show();
    }

    document.getElementById("registroForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const rol = rolSelect.value;
        const datos = {
            usuario: usuario.value.trim(),
            contrase√±a: contrase√±a.value.trim(),
            rol: rol
        };

        let valido = true;

        ["usuario", "contrase√±a", "rol"].forEach(id => {
            let campo = document.getElementById(id);
            if (!campo.value.trim()) { marcarError(campo); valido = false; }
        });

        if (!valido) return mostrarError("‚ö†Ô∏è Faltan campos obligatorios.");

        let camposExtras = [];

        if (rol === "medico") {
            camposExtras = [
                "medNombre", "medApellidos", "medTipoProfesional",
                "medTelefono", "medCorreo", "medTipoID", "medNumID",
                "medTarjetaProf"
            ];
        }

        if (rol === "admisionista") {
            camposExtras = [
                "admNombre", "admApellidos", "admTipoID", "admNumID",
                "admTelefono", "admCorreo", "admCargo", "admArea",
                "admFechaIngreso"
            ];
        }

        camposExtras.forEach(id => {
            const campo = document.getElementById(id);
            datos[id] = campo.value.trim();
            if (!campo.value.trim()) { marcarError(campo); valido = false; }
        });

        if (!valido) return mostrarError("‚ö†Ô∏è Completa todos los campos del formulario.");

        const res = await fetch("/register", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(datos)
        });

        const resp = await res.json();

        if (resp.status === "ok") {
            new bootstrap.Modal(document.getElementById("modalExito")).show();
            setTimeout(() => window.location.href = "/login", 2500);
        } else {
            mostrarError(resp.msg || "‚ùå Error desconocido.");
        }
    });

</script>

</body>
</html>
