<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iniciar Sesi√≥n - Sistema HCE</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: "Segoe UI", sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .login-container {
            max-width: 450px;
            width: 100%;
        }

        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 2.5rem;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-section {
            text-align: center;
            margin-bottom: 2rem;
        }

        .logo-icon {
            font-size: 4rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .login-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .login-subtitle {
            color: #718096;
            font-size: 0.95rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-control {
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
            outline: none;
        }

        .form-control.is-invalid {
            border-color: #dc3545;
            background-color: #fff5f5;
        }

        .invalid-feedback {
            display: block;
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .btn-login {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 10px;
            padding: 0.9rem;
            font-weight: 600;
            color: white;
            width: 100%;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 0.5rem;
        }

        .btn-login:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-login:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
        }

        .token-info {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 0.85rem;
        }

        .token-info-title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .token-status {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.25rem;
            color: #4a5568;
        }

        .token-status.valid {
            color: #22863a;
        }

        .token-status.expired {
            color: #cb2431;
        }

        .btn-logout {
            background: #dc3545;
            border: none;
            border-radius: 8px;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            color: white;
            cursor: pointer;
            margin-top: 0.5rem;
            width: 100%;
            transition: all 0.3s;
        }

        .btn-logout:hover {
            background: #c82333;
        }

        .alert-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }

        .separator {
            text-align: center;
            color: #cbd5e0;
            margin: 1.5rem 0;
            position: relative;
        }

        .separator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #cbd5e0;
        }

        .separator span {
            background: white;
            padding: 0 0.5rem;
            position: relative;
        }

        .footer-text {
            text-align: center;
            color: #718096;
            font-size: 0.8rem;
            margin-top: 1.5rem;
        }

        .demo-credentials {
            background: #f7fafc;
            border-radius: 10px;
            padding: 1rem;
            margin-top: 1.5rem;
        }

        .demo-credentials-title {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.75rem;
            font-size: 0.9rem;
        }

        .demo-user {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem;
            font-size: 0.8rem;
            color: #4a5568;
            border-bottom: 1px solid #e2e8f0;
        }

        .demo-user:last-child {
            border-bottom: none;
        }

        .demo-user-role {
            background: #667eea;
            color: white;
            padding: 0.1rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>

    <!-- Contenedor de Alertas -->
    <div id="alertContainer" class="alert-container"></div>

    <div class="login-container">
        <div class="login-card">

            <!-- Logo -->
            <div class="logo-section">
                <div class="logo-icon">üè•</div>
                <h1 class="login-title">Bienvenido</h1>
                <p class="login-subtitle">Sistema de Historia Cl√≠nica Electr√≥nica</p>
            </div>

            <!-- Informaci√≥n de Token (Si ya hay sesi√≥n) -->
            <div id="tokenInfo" class="token-info hidden">
                <div class="token-info-title">
                    üîê Sesi√≥n Activa
                </div>
                <div class="token-status" id="tokenStatus"></div>
                <div class="token-status" id="tokenExpires"></div>
                <button type="button" class="btn-logout" onclick="logout()">
                    üö™ Cerrar Sesi√≥n Actual
                </button>
            </div>

            <!-- Formulario de Login -->
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="username">üë§ Usuario</label>
                    <input 
                        type="text" 
                        id="username" 
                        class="form-control" 
                        placeholder="Ingrese su usuario" 
                        required
                        autocomplete="username"
                    >
                    <div class="invalid-feedback"></div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="password">üîë Contrase√±a</label>
                    <input 
                        type="password" 
                        id="password" 
                        class="form-control" 
                        placeholder="Ingrese su contrase√±a" 
                        required
                        autocomplete="current-password"
                    >
                    <div class="invalid-feedback"></div>
                </div>

                <button type="submit" class="btn-login" id="btnLogin">
                    <span id="btnText">Iniciar Sesi√≥n</span>
                    <span id="btnSpinner" class="spinner-border spinner-border-sm d-none"></span>
                </button>
            </form>

            <!-- Credenciales de Demostraci√≥n -->
            <div class="demo-credentials">
                <div class="demo-credentials-title">üìù Usuarios de Prueba</div>
                <div class="demo-user">
                    <span><strong>admin</strong> / <strong>admin</strong></span>
                    <span class="demo-user-role">ADMIN</span>
                </div>
                <div class="demo-user">
                    <span><strong>dr_rodriguez</strong> / <strong>password123</strong></span>
                    <span class="demo-user-role">MEDICO</span>
                </div>
                <div class="demo-user">
                    <span><strong>paciente_juan</strong> / <strong>password123</strong></span>
                    <span class="demo-user-role">PACIENTE</span>
                </div>
            </div>

            <p class="footer-text">
                üí° Sistema desarrollado con FastAPI + PostgreSQL + Citus + Bootstrap
            </p>
        </div>
    </div>

    <script src="../static/js/config.js"></script>

    <script>
        // ==================== INICIALIZACI√ìN ====================

        window.addEventListener('DOMContentLoaded', () => {
            console.log('üîç Analizando sesi√≥n actual...');
            
            // Si ya hay sesi√≥n activa, mostrar informaci√≥n del token
            if (AUTH_UTILS.isAuthenticated()) {
                mostrarInfoToken();
            }

            // Agregar validaci√≥n en tiempo real
            document.getElementById('username').addEventListener('input', limpiarError);
            document.getElementById('password').addEventListener('input', limpiarError);

            // Manejar Enter en los campos
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('loginForm').dispatchEvent(new Event('submit'));
                }
            });
        });

        // ==================== MOSTRAR INFORMACI√ìN DE TOKEN ====================

        function mostrarInfoToken() {
            const tokenInfo = document.getElementById('tokenInfo');
            const tokenStatus = document.getElementById('tokenStatus');
            const tokenExpires = document.getElementById('tokenExpires');
            
            const info = AUTH_UTILS.getTokenInfo();
            
            if (info) {
                tokenInfo.classList.remove('hidden');
                
                const isValid = AUTH_UTILS.isTokenValid();
                const statusClass = isValid ? 'valid' : 'expired';
                const statusText = isValid ? '‚úÖ V√°lido' : '‚ùå Expirado';
                
                tokenStatus.innerHTML = `
                    <span>Usuario: <strong>${info.username}</strong></span>
                    <span class="${statusClass}">${statusText}</span>
                `;
                
                const timeRemaining = this.formatTimeRemaining(info.expiresIn);
                tokenExpires.innerHTML = `
                    <span>Expira: ${info.expiresAt.toLocaleString('es-CO')}</span>
                    <span>${timeRemaining}</span>
                `;
                
                tokenExpires.className = `token-status ${statusClass}`;
            }
        }

        function formatTimeRemaining(seconds) {
            if (seconds < 0) {
                return '‚è∞ Expirado';
            }
            
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `‚è∞ ${days}d restante`;
            if (hours > 0) return `‚è∞ ${hours}h restante`;
            if (minutes > 0) return `‚è∞ ${minutes}m restante`;
            return `‚è∞ ${seconds}s restante`;
        }

        // ==================== LIMPIAR ERRORES ====================

        function limpiarError(e) {
            e.target.classList.remove('is-invalid');
            const feedback = e.target.nextElementSibling;
            if (feedback && feedback.classList.contains('invalid-feedback')) {
                feedback.textContent = '';
            }
        }

        // ==================== MOSTRAR ERROR ====================

        function mostrarError(campo, mensaje) {
            const input = document.getElementById(campo);
            input.classList.add('is-invalid');
            const feedback = input.nextElementSibling;
            if (feedback) {
                feedback.textContent = mensaje;
            }
        }

        // ==================== MOSTRAR ESTADO DE CARGA ====================

        function setLoading(loading) {
            const btnLogin = document.getElementById('btnLogin');
            const btnText = document.getElementById('btnText');
            const btnSpinner = document.getElementById('btnSpinner');
            
            if (loading) {
                btnText.classList.add('d-none');
                btnSpinner.classList.remove('d-none');
                btnLogin.disabled = true;
            } else {
                btnText.classList.remove('d-none');
                btnSpinner.classList.add('d-none');
                btnLogin.disabled = false;
            }
        }

        // ==================== VALIDAR CREDENCIALES ====================

        function validarCredenciales(username, password) {
            let valido = true;

            if (!username.trim()) {
                mostrarError('username', 'El usuario es requerido');
                valido = false;
            }

            if (!password.trim()) {
                mostrarError('password', 'La contrase√±a es requerida');
                valido = false;
            }

            if (username.trim().length < 3) {
                mostrarError('username', 'El usuario debe tener al menos 3 caracteres');
                valido = false;
            }

            return valido;
        }

        // ==================== MANEJAR ENV√çO DE FORMULARIO ====================

        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // Validar
            if (!validarCredenciales(username, password)) {
                return;
            }

            setLoading(true);

            try {
                console.log('üîê Intentando autenticar...', username);
                
                // Llamar al endpoint /token del backend
                const response = await API_UTILS.post(ENDPOINTS.LOGIN, {
                    username: username,
                    password: password
                });

                if (response && response.access_token && response.user) {
                    // Guardar credenciales
                    AUTH_UTILS.saveAuth(response.access_token, response.user);
                    SESSION_STATUS_UTILS.startTracking();

                    // Mostrar confirmaci√≥n
                    UI_UTILS.showAlert(
                        `‚úÖ ¬°Bienvenido ${response.user.nombres || response.user.username}!`,
                        'success',
                        2000
                    );

                    console.log('‚úÖ Autenticaci√≥n exitosa');
                    console.log('üë§ Usuario:', response.user);
                    console.log('üîê Token v√°lido por:', AUTH_UTILS.getTokenInfo().expiresIn, 'segundos');

                    // Redirigir seg√∫n rol despu√©s de 1 segundo
                    setTimeout(() => {
                        redirigirPorRol(response.user.rol);
                    }, 1000);

                } else {
                    throw new Error('Respuesta inv√°lida del servidor');
                }

            } catch (error) {
                console.error('‚ùå Error en autenticaci√≥n:', error);
                
                if (error.message.includes('401')) {
                    UI_UTILS.showAlert('‚ùå Credenciales inv√°lidas', 'danger');
                } else if (error.message.includes('503') || error.message.includes('timeout')) {
                    UI_UTILS.showAlert('‚ùå Servidor no disponible. Intenta m√°s tarde.', 'danger');
                } else {
                    UI_UTILS.showAlert(`‚ùå Error: ${error.message}`, 'danger');
                }

            } finally {
                setLoading(false);
            }
        });

        // ==================== REDIRIGIR SEG√öN ROL ====================

        function redirigirPorRol(rol) {
            const rutas = {
                'admin': 'panel_admin.html',
                'medico': 'medico.html',
                'admisionista': 'admisionista.html',
                'resultados': 'resultados.html',
                'paciente': 'paciente.html'
            };

            const ruta = rutas[rol] || 'medico.html';
            console.log(`üìç Redirigiendo a: ${ruta} (Rol: ${rol})`);
            window.location.href = ruta;
        }

        // ==================== CERRAR SESI√ìN ====================

        function logout() {
            if (confirm('¬øEst√°s seguro de que deseas cerrar sesi√≥n?')) {
                AUTH_UTILS.clearAuth();
                UI_UTILS.showAlert('‚úÖ Sesi√≥n cerrada correctamente', 'success', 1500);
                setTimeout(() => location.reload(), 1500);
            }
        }
    </script>
</body>
</html>