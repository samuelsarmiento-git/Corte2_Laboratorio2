<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historia Cl√≠nica PDF - HCE</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: "Segoe UI", sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
        }
        .pdf-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .pdf-header {
            background: white;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .pdf-viewer {
            flex: 1;
            background: white;
            margin: 1rem;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(102, 126, 234, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-content {
            text-align: center;
            color: white;
        }
        .spinner-border {
            width: 4rem;
            height: 4rem;
        }
        .btn-action {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .error-container {
            text-align: center;
            padding: 3rem;
            background: white;
            margin: 2rem;
            border-radius: 15px;
        }
        .error-icon {
            font-size: 5rem;
            color: #e74c3c;
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-content">
            <div class="spinner-border text-light mb-3" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <h4>Generando Historia Cl√≠nica en PDF...</h4>
            <p>Por favor espere</p>
        </div>
    </div>

    <!-- Contenido -->
    <div class="pdf-container">

        <!-- Header -->
        <div class="pdf-header">
            <div>
                <h5 class="mb-0">üìÑ Historia Cl√≠nica - Documento: <span id="documentoHeader"></span></h5>
            </div>
            <div>
                <button class="btn btn-action me-2" onclick="descargarPDF()">
                    üíæ Descargar
                </button>
                <button class="btn btn-secondary" onclick="cerrar()">
                    ‚Üê Volver
                </button>
            </div>
        </div>

        <!-- Visor PDF -->
        <div class="pdf-viewer" id="pdfViewer">
            <iframe id="pdfFrame" title="Historia Cl√≠nica PDF"></iframe>
        </div>

        <!-- Error Container (oculto por defecto) -->
        <div id="errorContainer" class="error-container d-none">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h3 class="text-danger mt-3">Error al Cargar PDF</h3>
            <p id="errorMessage" class="text-muted"></p>
            <button class="btn btn-action mt-3" onclick="reintentar()">
                üîÑ Reintentar
            </button>
            <button class="btn btn-secondary mt-3 ms-2" onclick="cerrar()">
                ‚Üê Volver
            </button>
        </div>

    </div>

    <script src="../static/js/config.js"></script>
    <script>
        // ==================== INICIALIZACI√ìN ====================
        let documentoActual = null;
        let pdfBlob = null;

        window.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                cargarPDF();
            }
        });

        // ==================== OBTENER DOCUMENTO ====================
        function getDocumentoFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('documento');
        }

        // ==================== VERIFICAR AUTENTICACI√ìN ====================
        function checkAuth() {
            if (!AUTH_UTILS.isAuthenticated()) {
                UI_UTILS.showAlert('Sesi√≥n expirada. Redirigiendo al login...', 'danger');
                setTimeout(() => window.location.href = 'login.html', 2000);
                return false;
            }
            return true;
        }

        // ==================== CARGAR PDF ====================
        async function cargarPDF() {
            documentoActual = getDocumentoFromURL();
            if (!documentoActual) {
                mostrarError('No se especific√≥ el documento del paciente');
                return;
            }
            document.getElementById('documentoHeader').textContent = documentoActual;

            try {
                const blob = await API_UTILS.downloadFile(ENDPOINTS.PACIENTES_PDF(documentoActual));
                if (blob) {
                    pdfBlob = blob;
                    const blobURL = window.URL.createObjectURL(pdfBlob);
                    document.getElementById('pdfFrame').src = blobURL;
                    ocultarLoading();
                }
            } catch (error) {
                mostrarError(error.message || 'Error al generar el PDF');
            }
        }

        // ==================== DESCARGAR PDF ====================
        function descargarPDF() {
            if (!pdfBlob) {
                UI_UTILS.showAlert('El PDF a√∫n no se ha cargado', 'warning');
                return;
            }
            const url = window.URL.createObjectURL(pdfBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `HistoriaClinica_${documentoActual}_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
            UI_UTILS.showAlert('PDF descargado correctamente', 'success');
        }

        // ==================== UTILIDADES ====================
        function ocultarLoading() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function mostrarError(mensaje) {
            ocultarLoading();
            document.getElementById('pdfViewer').classList.add('d-none');
            document.getElementById('errorContainer').classList.remove('d-none');
            document.getElementById('errorMessage').textContent = mensaje;
        }

        function reintentar() {
            document.getElementById('errorContainer').classList.add('d-none');
            document.getElementById('pdfViewer').classList.remove('d-none');
            document.getElementById('loadingOverlay').style.display = 'flex';
            cargarPDF();
        }

        function cerrar() {
            window.history.back();
        }

        // ==================== MANEJO DE ERRORES DEL IFRAME ====================
        document.getElementById('pdfFrame').addEventListener('error', () => {
            mostrarError('Error al cargar el visor de PDF. Intente descargar el archivo.');
        });

        // ==================== PREVENIR NAVEGACI√ìN ACCIDENTAL ====================
        window.addEventListener('beforeunload', (e) => {
            if (pdfBlob) {
                const iframe = document.getElementById('pdfFrame');
                if (iframe.src) {
                    window.URL.revokeObjectURL(iframe.src);
                }
            }
        });
    </script>
</body>
</html>