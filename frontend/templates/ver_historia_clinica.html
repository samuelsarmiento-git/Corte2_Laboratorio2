<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historia Cl√≠nica - HCE</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: "Segoe UI", sans-serif;
            padding: 2rem 0;
        }
        .historia-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .header-paciente {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
            text-align: center;
        }
        .section-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 10px;
            margin: 2rem 0 1rem 0;
            font-weight: 600;
        }
        .info-row {
            padding: 0.75rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label {
            font-weight: 600;
            color: #495057;
            min-width: 250px;
        }
        .info-value {
            color: #212529;
            flex: 1;
        }
        .alert-alergias {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
        }
        .btn-action {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .loading {
            text-align: center;
            padding: 3rem;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="historia-container">

            <!-- Loading -->
            <div id="loading" class="loading">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <p class="mt-3 text-muted">Cargando historia cl√≠nica...</p>
            </div>

            <!-- Contenido -->
            <div id="content" class="d-none">

                <!-- Header -->
                <div class="header-paciente">
                    <h2 class="mb-2" id="nombrePaciente"></h2>
                    <h5>Documento: <span id="documentoPaciente"></span></h5>
                    <p class="mb-0">Historia Cl√≠nica Electr√≥nica</p>
                </div>

                <!-- Botones de Acci√≥n -->
                <div class="text-end mb-3">
                    <button class="btn btn-secondary me-2" onclick="window.history.back()">
                        ‚Üê Volver
                    </button>
                    <button class="btn btn-action me-2" onclick="editarHistoria()">
                        ‚úèÔ∏è Editar
                    </button>
                    <button class="btn btn-action" onclick="descargarPDF()">
                        üìÑ Descargar PDF
                    </button>
                </div>

                <!-- IDENTIFICACI√ìN -->
                <div class="section-title">üë§ DATOS DE IDENTIFICACI√ìN</div>
                <div id="seccionIdentificacion"></div>

                <!-- ATENCI√ìN -->
                <div class="section-title">üè• DATOS DE ATENCI√ìN</div>
                <div id="seccionAtencion"></div>

                <!-- ALERGIAS (destacado si existen) -->
                <div id="seccionAlergias"></div>

                <!-- ANTECEDENTES -->
                <div class="section-title">üìù ANTECEDENTES</div>
                <div id="seccionAntecedentes"></div>

                <!-- SIGNOS VITALES -->
                <div class="section-title">üíì SIGNOS VITALES</div>
                <div id="seccionSignosVitales"></div>

                <!-- EXAMEN F√çSICO -->
                <div class="section-title">üî¨ EXAMEN F√çSICO</div>
                <div id="seccionExamen"></div>

                <!-- DIAGN√ìSTICO -->
                <div class="section-title">üìã DIAGN√ìSTICO</div>
                <div id="seccionDiagnostico"></div>

                <!-- TRATAMIENTO -->
                <div class="section-title">üíä TRATAMIENTO</div>
                <div id="seccionTratamiento"></div>

                <!-- PROCEDIMIENTOS -->
                <div class="section-title">üî¨ PROCEDIMIENTOS Y RESULTADOS</div>
                <div id="seccionProcedimientos"></div>

                <!-- EVOLUCI√ìN -->
                <div class="section-title">üìä EVOLUCI√ìN Y EGRESO</div>
                <div id="seccionEvolucion"></div>

                <!-- PROFESIONAL -->
                <div class="section-title">üë®‚Äç‚öïÔ∏è PROFESIONAL RESPONSABLE</div>
                <div id="seccionProfesional"></div>

            </div>

            <!-- Sin Datos -->
            <div id="noData" class="d-none text-center py-5">
                <div style="font-size: 5rem;">üìã</div>
                <h4 class="text-muted mt-3">Paciente no encontrado</h4>
            </div>

        </div>
    </div>

    <script src="../static/js/config.js"></script>
    <script>
        // ==================== INICIALIZACI√ìN ====================
        let documentoActual = null;

        window.addEventListener('DOMContentLoaded', () => {
            if (checkAuth()) {
                cargarHistoria();
            }
        });

        // ==================== VERIFICAR AUTENTICACI√ìN ====================
        function checkAuth() {
            return AUTH_UTILS.isAuthenticated();
        }

        // ==================== OBTENER DOCUMENTO DE URL ====================
        function getDocumentoFromURL() {
            const params = new URLSearchParams(window.location.search);
            return params.get('documento');
        }

        // ==================== CARGAR HISTORIA ====================
        async function cargarHistoria() {
            documentoActual = getDocumentoFromURL();

            if (!documentoActual) {
                document.getElementById('loading').classList.add('d-none');
                document.getElementById('noData').classList.remove('d-none');
                return;
            }

            try {
                const paciente = await API_UTILS.get(ENDPOINTS.PACIENTES_DETAIL(documentoActual));
                if (paciente) {
                    mostrarHistoria(paciente);
                } else {
                    document.getElementById('loading').classList.add('d-none');
                    document.getElementById('noData').classList.remove('d-none');
                }
            } catch (error) {
                UI_UTILS.showAlert('Error al cargar la historia cl√≠nica', 'danger');
            }
        }

        // ==================== MOSTRAR HISTORIA ====================
        function mostrarHistoria(p) {
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('content').classList.remove('d-none');

            // Header
            const nombreCompleto = `${p.primer_nombre || ''} ${p.segundo_nombre || ''} ${p.primer_apellido || ''} ${p.segundo_apellido || ''}`.trim();
            document.getElementById('nombrePaciente').textContent = nombreCompleto;
            document.getElementById('documentoPaciente').textContent = p.numero_documento;

            // IDENTIFICACI√ìN
            document.getElementById('seccionIdentificacion').innerHTML = `
                <div class="info-row"><div class="info-label">Tipo de Documento:</div><div class="info-value">${p.tipo_documento || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">N√∫mero de Documento:</div><div class="info-value">${p.numero_documento}</div></div>
                <div class="info-row"><div class="info-label">Nombres:</div><div class="info-value">${p.primer_nombre || ''} ${p.segundo_nombre || ''}</div></div>
                <div class="info-row"><div class="info-label">Apellidos:</div><div class="info-value">${p.primer_apellido || ''} ${p.segundo_apellido || ''}</div></div>
                <div class="info-row"><div class="info-label">Fecha de Nacimiento:</div><div class="info-value">${UI_UTILS.formatDate(p.fecha_nacimiento)}</div></div>
                <div class="info-row"><div class="info-label">Edad:</div><div class="info-value">${p.edad || 'N/A'} a√±os</div></div>
                <div class="info-row"><div class="info-label">Sexo:</div><div class="info-value">${p.sexo || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">G√©nero:</div><div class="info-value">${p.genero || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Grupo Sangu√≠neo:</div><div class="info-value">${p.grupo_sanguineo || 'N/A'} ${p.factor_rh || ''}</div></div>
                <div class="info-row"><div class="info-label">Estado Civil:</div><div class="info-value">${p.estado_civil || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Direcci√≥n:</div><div class="info-value">${p.direccion_residencia || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Municipio/Departamento:</div><div class="info-value">${p.municipio || 'N/A'}, ${p.departamento || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Tel√©fono:</div><div class="info-value">${p.telefono || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Celular:</div><div class="info-value">${p.celular || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Correo:</div><div class="info-value">${p.correo_electronico || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Ocupaci√≥n:</div><div class="info-value">${p.ocupacion || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">EPS/ARL:</div><div class="info-value">${p.entidad || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">R√©gimen:</div><div class="info-value">${p.regimen_afiliacion || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Tipo de Usuario:</div><div class="info-value">${p.tipo_usuario || 'N/A'}</div></div>
            `;

            // ATENCI√ìN
            document.getElementById('seccionAtencion').innerHTML = `
                <div class="info-row"><div class="info-label">Fecha de Atenci√≥n:</div><div class="info-value">${UI_UTILS.formatDateTime(p.fecha_atencion)}</div></div>
                <div class="info-row"><div class="info-label">Tipo de Atenci√≥n:</div><div class="info-value">${p.tipo_atencion || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Motivo de Consulta:</div><div class="info-value">${p.motivo_consulta || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Enfermedad Actual:</div><div class="info-value">${p.enfermedad_actual || 'N/A'}</div></div>
            `;

            // ALERGIAS (destacadas)
            if (p.alergias_conocidas) {
                document.getElementById('seccionAlergias').innerHTML = `
                    <div class="alert-alergias">
                        <strong>‚ö†Ô∏è ALERGIAS CONOCIDAS:</strong> ${p.alergias_conocidas}
                    </div>
                `;
            }

            // ANTECEDENTES
            document.getElementById('seccionAntecedentes').innerHTML = `
                <div class="info-row"><div class="info-label">Antecedentes Personales:</div><div class="info-value">${p.antecedentes_personales || 'Ninguno registrado'}</div></div>
                <div class="info-row"><div class="info-label">Antecedentes Familiares:</div><div class="info-value">${p.antecedentes_familiares || 'Ninguno registrado'}</div></div>
                <div class="info-row"><div class="info-label">H√°bitos:</div><div class="info-value">${p.habitos || 'Ninguno registrado'}</div></div>
                <div class="info-row"><div class="info-label">Medicamentos Actuales:</div><div class="info-value">${p.medicamentos_actuales || 'Ninguno'}</div></div>
            `;

            // SIGNOS VITALES
            const imc = p.imc ? `${p.imc} kg/m¬≤` : 'N/A';
            document.getElementById('seccionSignosVitales').innerHTML = `
                <div class="info-row"><div class="info-label">Tensi√≥n Arterial:</div><div class="info-value">${p.tension_arterial || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Frecuencia Card√≠aca:</div><div class="info-value">${p.frecuencia_cardiaca || 'N/A'} lpm</div></div>
                <div class="info-row"><div class="info-label">Frecuencia Respiratoria:</div><div class="info-value">${p.frecuencia_respiratoria || 'N/A'} rpm</div></div>
                <div class="info-row"><div class="info-label">Temperatura:</div><div class="info-value">${p.temperatura || 'N/A'} ¬∞C</div></div>
                <div class="info-row"><div class="info-label">Saturaci√≥n O‚ÇÇ:</div><div class="info-value">${p.saturacion_oxigeno || 'N/A'} %</div></div>
                <div class="info-row"><div class="info-label">Peso:</div><div class="info-value">${p.peso || 'N/A'} kg</div></div>
                <div class="info-row"><div class="info-label">Talla:</div><div class="info-value">${p.talla || 'N/A'} cm</div></div>
                <div class="info-row"><div class="info-label">IMC:</div><div class="info-value">${imc}</div></div>
            `;

            // EXAMEN F√çSICO
            document.getElementById('seccionExamen').innerHTML = `
                <div class="info-row"><div class="info-label">Examen F√≠sico General:</div><div class="info-value">${p.examen_fisico_general || 'No registrado'}</div></div>
                <div class="info-row"><div class="info-label">Examen por Sistemas:</div><div class="info-value">${p.examen_fisico_sistemas || 'No registrado'}</div></div>
            `;

            // DIAGN√ìSTICO
            document.getElementById('seccionDiagnostico').innerHTML = `
                <div class="info-row"><div class="info-label">Impresi√≥n Diagn√≥stica:</div><div class="info-value">${p.impresion_diagnostica || 'No registrada'}</div></div>
                <div class="info-row"><div class="info-label">C√≥digos CIE-10:</div><div class="info-value">${p.codigos_cie10 || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Diagn√≥stico Definitivo:</div><div class="info-value">${p.diagnostico_definitivo || 'Pendiente'}</div></div>
                <div class="info-row"><div class="info-label">Conducta/Plan:</div><div class="info-value">${p.conducta_plan || 'No especificado'}</div></div>
                <div class="info-row"><div class="info-label">Recomendaciones:</div><div class="info-value">${p.recomendaciones || 'Ninguna'}</div></div>
            `;

            // TRATAMIENTO
            document.getElementById('seccionTratamiento').innerHTML = `
                <div class="info-row"><div class="info-label">Tratamiento Instaurado:</div><div class="info-value">${p.tratamiento_instaurado || 'No especificado'}</div></div>
                <div class="info-row"><div class="info-label">Formulaci√≥n M√©dica:</div><div class="info-value">${p.formulacion_medica || 'Sin formulaci√≥n'}</div></div>
                <div class="info-row"><div class="info-label">Educaci√≥n al Paciente:</div><div class="info-value">${p.educacion_paciente || 'No registrada'}</div></div>
            `;

            // PROCEDIMIENTOS
            document.getElementById('seccionProcedimientos').innerHTML = `
                <div class="info-row"><div class="info-label">M√©dicos Interconsultados:</div><div class="info-value">${p.medicos_interconsultados || 'Ninguno'}</div></div>
                <div class="info-row"><div class="info-label">Procedimientos Realizados:</div><div class="info-value">${p.procedimientos_realizados || 'Ninguno'}</div></div>
                <div class="info-row"><div class="info-label">Resultados de Ex√°menes:</div><div class="info-value">${p.resultados_examenes || 'Sin resultados'}</div></div>
            `;

            // EVOLUCI√ìN
            document.getElementById('seccionEvolucion').innerHTML = `
                <div class="info-row"><div class="info-label">Evoluci√≥n M√©dica:</div><div class="info-value">${p.evolucion_medica || 'No registrada'}</div></div>
                <div class="info-row"><div class="info-label">Estado de Egreso:</div><div class="info-value">${p.estado_egreso || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Referencia/Contrarreferencia:</div><div class="info-value">${p.referencia_contrarreferencia || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Fecha de Cierre:</div><div class="info-value">${UI_UTILS.formatDateTime(p.fecha_cierre)}</div></div>
            `;

            // PROFESIONAL
            document.getElementById('seccionProfesional').innerHTML = `
                <div class="info-row"><div class="info-label">Nombre:</div><div class="info-value">${p.nombre_profesional || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Tipo:</div><div class="info-value">${p.tipo_profesional || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Registro M√©dico:</div><div class="info-value">${p.registro_medico || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Cargo/Servicio:</div><div class="info-value">${p.cargo_servicio || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Responsable de Registro:</div><div class="info-value">${p.responsable_registro || 'N/A'}</div></div>
                <div class="info-row"><div class="info-label">Fecha de Registro:</div><div class="info-value">${UI_UTILS.formatDateTime(p.fecha_registro)}</div></div>
            `;
        }

        // ==================== EDITAR HISTORIA ====================
        function editarHistoria() {
            window.location.href = `editar_historia_clinica.html?documento=${documentoActual}`;
        }

        // ==================== DESCARGAR PDF ====================
        async function descargarPDF() {
            try {
                await API_UTILS.downloadFile(ENDPOINTS.PACIENTES_PDF(documentoActual), `HC_${documentoActual}.pdf`);
                UI_UTILS.showAlert('PDF descargado exitosamente', 'success');
            } catch (error) {
                UI_UTILS.showAlert('Error al descargar el PDF', 'danger');
            }
        }
    </script>
</body>
</html>